<!DOCTYPE html>
<html>

    <head>
        <title>Percy The Mars Rover</title>
        <link href='./style.css' rel='stylesheet'>
        <link rel="stylesheet"
            href="https://fonts.googleapis.com/css?family=Roboto+Mono">
      <style>
        body {
          font-family: 'Roboto Mono', monospace;
        }
      </style>

<script src="https://cdn.plot.ly/plotly-2.0.0-rc.3.min.js"></script>
    </head>

    <body>

        <section class = 'main-sec' id = "status"> 
            <h1>Rover Status</h1>

            <div id = "stat-cont">

            <section class = 'sub-sec'> 
                <h2>Energy Status</h2> 
                <div class="battery">
                    <div class="battery-shell"><div id="battery-level"></div></div>
                    <div class="battery-lid"></div>
                    <p id='battery-percent'> &#9735;50% </p>
                    <p id='battery-ttl'> 29 mins until full </p>
                </div>
            </section>
            
            <section class = 'sub-sec' id = 'speed'> 
                <h2>Speedometer</h2> 
                <div id="speedometer"> 
                    <p id='speed-units'>cm/s</p>
                </div>
                
            </section>

            <section class = 'sub-sec'> 
                <h2>Current Trip Details</h2> 
                <table>
                    <tr>
                        <td>Distance Traveled</td> 
                        <td>0m</td> 
                    </tr>

                    <tr>
                        <td>Time of Current Trip</td>
                        <td>0 mins</td>  
                    </tr>

                    <tr>
                        <td>Current Gear</td>
                        <td id="curr-gear">P</td> 
                    </tr>

                    <tr>
                        <td>Current Coordinates</td>
                        <td>(0, 0)</td> 
                    </tr>
                </table>
            </section>
            </div>
        </section>

        <br/>
        <div id="imag">
            <br><br>
        </div>

        <section class = 'main-sec' id = "control">
            <h1>Mission Control</h1>
            <!-- Current Status, Automatic, Manual, Target, Notification feed, minimap-->

            <div class = 'bdiv' id='commands'>

                <div class='switch-div'>
                    <strong class = 'switch-label'> Manual</strong> 
                    <input type="checkbox" id="switch" /><label for="switch"></label> 
                    <strong class = 'switch-label'> Autonomous</strong>
                    <p id='manual-warning'><span id="manual-warning-text">WARNING: Rover may collide with obstacles in this mode</span> </p>
                </div>

                <div class = 'keypad' id='keypad-id'>
                    <button type="button" class = 'keypad-button alone-key' id = 'up-key'>&#8593;</button>
                    <div id="turn-key-div">
                        <button type="button" class = 'keypad-button lrs-key' id = 'left-key'>&#10226;</button>
                        <button type="button" class = 'keypad-button lrs-key' id = 'stop-key'>STOP</button>
                        <button type="button" class = 'keypad-button lrs-key' id = 'right-key'>&#10227;</button>
                    </div>
                        <button type="button" class = 'keypad-button alone-key' id = 'down-key'>&#8595;</button> 
                </div>

                <br/>

                <div class = 'speed-control' id='speed-control-id'>
                    <div class="slider" id="curr-val">
                        <span id="curr-speed-text">Speed (cm/s) :&nbsp;<span id="curr-speed-val">6.0</span></span>
                    </div>
                    <div class="slider" id="acc-slider">
                        <div id="min-slider-val">6 </div>
                        <input type="range" min="6.0" max="16.5" step="0.1" value="6.0" id = 'speed-slider'>
                        <div id="max-slider-val"> 16.5</div>
                    </div>
                </div>

            </div>

            <div class = 'bdiv' id='map'> 
                
            </div>



        </section>

        <script>
            //function definitions

            async function fetchData(url='', ){
                let promise = await fetch(url);
                let data = promise.json();
                return data;

            }

            async function postData(url = '', data = {}) {
                console.log(JSON.stringify(data));
                const response = await fetch(url, {
                    method: 'POST', // *GET, POST, PUT, DELETE, etc.
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data) // body data type must match "Content-Type" header
                });
                return response.json(); // parses JSON response into native JavaScript objects
            }
        </script>

        <script>
            const recieved = fetchData("http://localhost:9000/api/test")
            // fetch()
            //     .then(response => response.json())
            //     .then(data => console.log(data))
            let speed = 6;

        //TO-DO: Add an if manual condition!
        //  updating current gear 
            const upKey = document.querySelector("#up-key");
            const downKey = document.querySelector("#down-key");
            const leftKey = document.querySelector("#left-key");
            const rightKey = document.querySelector("#right-key");
            const stopKey = document.querySelector("#stop-key");
            const currGear = document.querySelector("#curr-gear");
            console.log(upKey===document.getElementById('up-key'))
            upKey.onclick = function(event){
                currGear.textContent='D'; 
                postData("http://localhost:9000/api/direction", {direction: 'D'});
            };
            downKey.onclick = function(event){                
                currGear.textContent='R'; 
                postData("http://localhost:9000/api/direction", {direction: 'R'});
            };
            leftKey.onclick = function(event){
                currGear.textContent='RL';
                postData("http://localhost:9000/api/direction", {direction: 'RL'});
            };
            rightKey.onclick = function(event){
                currGear.textContent='RR';
                postData("http://localhost:9000/api/direction", {direction: 'RR'});
            };
            stopKey.onclick = function(event){
                currGear.textContent='P';
                postData("http://localhost:9000/api/direction", {direction: 'P'});
            };

        //  Speedometer 
            let data = [{
            domain: { x: [0, 1], y: [0, 1] },
            value: speed,
            type: "indicator",
            mode: "gauge+number",
            gauge:{
                axis: { range: [null, 18]},
                bar: { color: '#3BF014'},
                borderwidth: 3,
                bordercolor: "#ffebdb"
                // steps: [
                //         {'range': [0, 10], bar: {'color': 'green'}},
                //         {'range': [10, 15.5], bar: {'color': 'yellow'}},
                //         {'range': [15.5,18], bar: {'color': 'red'}}]

                }
            }];

            let layout = { 
                height: 275, 
                width: 550, 
                paper_bgcolor: "#35499b", 
                margin: { t: 0, b: 0 }, 
                font: { color: "#ffebdb", family: "Roboto Mono" }
            };
            Plotly.newPlot('speedometer', data, layout);

        //  graphing stuff
            let plotDiv = document.getElementById('map')
            
            let rover ={
                x:[0],
                y:[0],
                mode: 'markers',
                marker: {
                    size: 15
                },
                type: 'scatter',
                name: 'Rover'
            };

            let redBall ={
                x:[-4],
                y:[-7],
                mode: 'markers',
                marker: {
                    size: 15
                },
                type: 'scatter'
            };

            let blueBall ={
                x:[6],
                y:[8],
                mode: 'markers',
                marker: {
                    size: 15
                },
                type: 'scatter'
            };

            let data1 = [rover, redBall, blueBall];

            let layout1 = {
                paper_bgcolor: "#ffebd9",
                plot_bgcolor: "#ffebdb"
            };

            Plotly.newPlot( 
                plotDiv, 
                data1,
                layout1
                );
            
            //  updating speed display
            const displayCurrVal = document.querySelector('#curr-speed-val');
            const inputVal = document.querySelector("#speed-slider");
            //TO-DO: Add an if manual condition!
            inputVal.oninput = ( ()=>{ 
                displayCurrVal.textContent = inputVal.value;
                speed = inputVal.value;
                postData("http://localhost:9000/api/speed", {speed: speed});

                // console.log("Speed inputted is =", speed)
                // data[0].value=speed;
                // console.log("Value stored in gauge container is: ", data[0].value);

                data = [{
                    domain: { x: [0, 1], y: [0, 1] },
                    value: speed,
                    type: "indicator",
                    mode: "gauge+number",
                    gauge:{
                        axis: { range: [null, 18]},
                        bar: { color: (speed<10? '#3BF014' : speed<15? '#FFFF00' : '#FF0000')},
                        borderwidth: 3,
                        bordercolor: "#ffebdb"
                        }
                }];

                Plotly.newPlot('speedometer', data, layout);

                
            });

        </script>

        <audio autoplay loop>
            <source src = "Source/FILTERED_HIGHLIGHTS_-_Sol16RoverDriveHighlights.mp3" type = "audio/mp3">
        </audio>


    </body>

    <footer>
    
    </footer>
</html>